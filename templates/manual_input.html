{% extends "base.html" %}

{% block title %}Manual Input - Rubik's Cube Solver{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="text-center mb-4">
                <h2 class="text-white">
                    <i class="fas fa-keyboard"></i> Manual Cube Input
                </h2>
                <p class="text-white-50">Click on each square to select its color, or type color strings (e.g., "ggroowwbb") for each face!</p>
            </div>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-body">
                    <!-- Color Palette -->
                    <div class="row mb-4">
                        <div class="col-12 text-center">
                            <h5>Color Palette</h5>
                            <div class="color-palette d-flex justify-content-center flex-wrap gap-2 mt-3">
                                <div class="color-option cube-face color-red" data-color="R" title="Red"></div>
                                <div class="color-option cube-face color-green" data-color="G" title="Green"></div>
                                <div class="color-option cube-face color-blue" data-color="B" title="Blue"></div>
                                <div class="color-option cube-face color-yellow" data-color="Y" title="Yellow"></div>
                                <div class="color-option cube-face color-orange" data-color="O" title="Orange"></div>
                                <div class="color-option cube-face color-white" data-color="W" title="White"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3D Cube Visualization (React) -->
                    <div class="row mb-4">
                        <div class="col-12 text-center">
                            <h5>3D Cube Preview</h5>
                            <div class="cube-3d-container">
                                <div id="react-cube-root"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cube Faces -->
                    <div class="cube-container">
                        <!-- Top Face (Up) -->
                        <div class="row justify-content-center mb-3">
                            <div class="col-auto">
                                <h6 class="text-center">Up Face</h6>
                                <div class="cube-grid" id="up-face">
                                    <div class="cube-face" data-face="up" data-pos="0"></div>
                                    <div class="cube-face" data-face="up" data-pos="1"></div>
                                    <div class="cube-face" data-face="up" data-pos="2"></div>
                                    <div class="cube-face" data-face="up" data-pos="3"></div>
                                    <div class="cube-face" data-face="up" data-pos="4"></div>
                                    <div class="cube-face" data-face="up" data-pos="5"></div>
                                    <div class="cube-face" data-face="up" data-pos="6"></div>
                                    <div class="cube-face" data-face="up" data-pos="7"></div>
                                    <div class="cube-face" data-face="up" data-pos="8"></div>
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="up-input" placeholder="Enter 9 colors (e.g., WWWWWWWWW)" 
                                           maxlength="9" data-face="up" value="">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Middle Row -->
                        <div class="row justify-content-center mb-3">
                            <!-- Left Face -->
                            <div class="col-auto">
                                <h6 class="text-center">Left Face</h6>
                                <div class="cube-grid" id="left-face">
                                    <div class="cube-face" data-face="left" data-pos="0"></div>
                                    <div class="cube-face" data-face="left" data-pos="1"></div>
                                    <div class="cube-face" data-face="left" data-pos="2"></div>
                                    <div class="cube-face" data-face="left" data-pos="3"></div>
                                    <div class="cube-face" data-face="left" data-pos="4"></div>
                                    <div class="cube-face" data-face="left" data-pos="5"></div>
                                    <div class="cube-face" data-face="left" data-pos="6"></div>
                                    <div class="cube-face" data-face="left" data-pos="7"></div>
                                    <div class="cube-face" data-face="left" data-pos="8"></div>
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="left-input" placeholder="Enter 9 colors (e.g., GGGGGGGGG)" 
                                           maxlength="9" data-face="left" value="">
                                </div>
                            </div>
                            
                            <!-- Front Face -->
                            <div class="col-auto">
                                <h6 class="text-center">Front Face</h6>
                                <div class="cube-grid" id="front-face">
                                    <div class="cube-face" data-face="front" data-pos="0"></div>
                                    <div class="cube-face" data-face="front" data-pos="1"></div>
                                    <div class="cube-face" data-face="front" data-pos="2"></div>
                                    <div class="cube-face" data-face="front" data-pos="3"></div>
                                    <div class="cube-face" data-face="front" data-pos="4"></div>
                                    <div class="cube-face" data-face="front" data-pos="5"></div>
                                    <div class="cube-face" data-face="front" data-pos="6"></div>
                                    <div class="cube-face" data-face="front" data-pos="7"></div>
                                    <div class="cube-face" data-face="front" data-pos="8"></div>
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="front-input" placeholder="Enter 9 colors (e.g., RRRRRRRRR)" 
                                           maxlength="9" data-face="front" value="">
                                </div>
                            </div>
                            
                            <!-- Right Face -->
                            <div class="col-auto">
                                <h6 class="text-center">Right Face</h6>
                                <div class="cube-grid" id="right-face">
                                    <div class="cube-face" data-face="right" data-pos="0"></div>
                                    <div class="cube-face" data-face="right" data-pos="1"></div>
                                    <div class="cube-face" data-face="right" data-pos="2"></div>
                                    <div class="cube-face" data-face="right" data-pos="3"></div>
                                    <div class="cube-face" data-face="right" data-pos="4"></div>
                                    <div class="cube-face" data-face="right" data-pos="5"></div>
                                    <div class="cube-face" data-face="right" data-pos="6"></div>
                                    <div class="cube-face" data-face="right" data-pos="7"></div>
                                    <div class="cube-face" data-face="right" data-pos="8"></div>
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="right-input" placeholder="Enter 9 colors (e.g., BBBBBBBBB)" 
                                           maxlength="9" data-face="right" value="">
                                </div>
                            </div>
                            
                            <!-- Back Face -->
                            <div class="col-auto">
                                <h6 class="text-center">Back Face</h6>
                                <div class="cube-grid" id="back-face">
                                    <div class="cube-face" data-face="back" data-pos="0"></div>
                                    <div class="cube-face" data-face="back" data-pos="1"></div>
                                    <div class="cube-face" data-face="back" data-pos="2"></div>
                                    <div class="cube-face" data-face="back" data-pos="3"></div>
                                    <div class="cube-face" data-face="back" data-pos="4"></div>
                                    <div class="cube-face" data-face="back" data-pos="5"></div>
                                    <div class="cube-face" data-face="back" data-pos="6"></div>
                                    <div class="cube-face" data-face="back" data-pos="7"></div>
                                    <div class="cube-face" data-face="back" data-pos="8"></div>
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="back-input" placeholder="Enter 9 colors (e.g., OOOOOOOOO)" 
                                           maxlength="9" data-face="back" value="">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bottom Face -->
                        <div class="row justify-content-center mb-4">
                            <div class="col-auto">
                                <h6 class="text-center">Down Face</h6>
                                <div class="cube-grid" id="down-face">
                                    <div class="cube-face" data-face="down" data-pos="0"></div>
                                    <div class="cube-face" data-face="down" data-pos="1"></div>
                                    <div class="cube-face" data-face="down" data-pos="2"></div>
                                    <div class="cube-face" data-face="down" data-pos="3"></div>
                                    <div class="cube-face" data-face="down" data-pos="4"></div>
                                    <div class="cube-face" data-face="down" data-pos="5"></div>
                                    <div class="cube-face" data-face="down" data-pos="6"></div>
                                    <div class="cube-face" data-face="down" data-pos="7"></div>
                                    <div class="cube-face" data-face="down" data-pos="8"></div>
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="down-input" placeholder="Enter 9 colors (e.g., YYYYYYYYY)" 
                                           maxlength="9" data-face="down" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Controls -->
                    <div class="row">
                        <div class="col-12 text-center">
                            <button id="reset-btn" class="btn btn-warning me-2">
                                <i class="fas fa-undo"></i> Reset Cube
                            </button>
                            <button id="solve-btn" class="btn btn-primary btn-lg">
                                <i class="fas fa-magic"></i> Solve Cube
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress Indicator -->
                    <div id="progress-container" class="mt-4" style="display: none;">
                        <div class="text-center">
                            <div class="loading-spinner"></div>
                            <p class="mt-2">Solving cube...</p>
                        </div>
                    </div>
                    
                    <!-- Solution Display -->
                    <div id="solution-container" class="solution-container" style="display: none;">
                        <h4 class="text-center mb-3">
                            <i class="fas fa-check-circle text-success"></i> Solution Found!
                        </h4>
                        <div class="alert alert-success">
                            <strong>Move Count:</strong> <span id="move-count">0</span> moves
                        </div>
                        
                        <!-- 3D Cube with Playback Controls -->
                        <div class="solution-3d-section mb-4">
                            <div class="cube-3d-container-solution">
                                <div class="cube-3d-solution" id="cube-3d-solution">
                                    <!-- 3D cube for solution playback -->
                                </div>
                            </div>
                            
                            <!-- Playback Controls -->
                            <div class="playback-controls">
                                <div class="control-buttons">
                                    <button id="rewind-start" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-fast-backward"></i>
                                    </button>
                                    <button id="play-pause" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button id="step-forward" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-step-forward"></i>
                                    </button>
                                    <button id="skip-end" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-fast-forward"></i>
                                    </button>
                                </div>
                                
                                <div class="progress-section">
                                    <input type="range" id="solution-progress" class="form-range" min="0" max="100" value="0">
                                    <span id="speed-indicator" class="badge bg-info">3 s/rot</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Move List -->
                        <div class="move-list-section mb-4">
                            <h5>Move Sequence:</h5>
                            <div class="move-sequence-display" id="move-sequence-display">
                                <!-- Move sequence will be displayed here -->
                            </div>
                        </div>
                        
                        <!-- Step Grid -->
                        <div class="step-grid-section">
                            <h5>Step-by-Step Solution:</h5>
                            <div class="step-grid" id="step-grid">
                                <!-- Step grid will be generated here -->
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                Move notation: U=Up, D=Down, L=Left, R=Right, F=Front, B=Back<br>
                                ' = Counterclockwise, 2 = Double turn
                            </small>
                        </div>
                    </div>
                    
                    <!-- Error Display -->
                    <div id="error-container" class="mt-4" style="display: none;">
                        <div class="alert alert-danger">
                            <strong>Error:</strong> <span id="error-message"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Load the React 3D Cube bundle (adjust path as needed) -->
<script src="/static/js/main.js"></script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedColor = 'W'; // Default to white
    let cubeState = {
        up: Array(9).fill('W'),
        down: Array(9).fill('W'),
        front: Array(9).fill('W'),
        back: Array(9).fill('W'),
        left: Array(9).fill('W'),
        right: Array(9).fill('W')
    };
    
    let solutionSteps = [];
    let currentStep = 0;
    let isPlaying = false;
    let playInterval = null;
    
    // Color class mapping
    const colorClasses = {
        'R': 'color-red',
        'G': 'color-green',
        'B': 'color-blue',
        'Y': 'color-yellow',
        'O': 'color-orange',
        'W': 'color-white'
    };
    
    // Color string to color mapping (case insensitive)
    const colorStringMap = {
        'r': 'R', 'R': 'R',
        'g': 'G', 'G': 'G',
        'b': 'B', 'B': 'B',
        'y': 'Y', 'Y': 'Y',
        'o': 'O', 'O': 'O',
        'w': 'W', 'W': 'W'
    };
    
    // Initialize cube with default colors
    function initializeCube() {
        // Set default solved cube
        const defaultColors = {
            up: Array(9).fill('W'),
            down: Array(9).fill('Y'),
            front: Array(9).fill('R'),
            back: Array(9).fill('O'),
            left: Array(9).fill('G'),
            right: Array(9).fill('B')
        };
        
        Object.keys(defaultColors).forEach(face => {
            for (let i = 0; i < 9; i++) {
                const element = document.querySelector(`[data-face="${face}"][data-pos="${i}"]`);
                const color = defaultColors[face][i];
                updateSquareColor(element, color);
                cubeState[face][i] = color;
            }
        });
        

    }
    
    // Parse color string and update face
    function parseColorString(face, colorString) {
        if (colorString.length !== 9) {
            return false;
        }
        
        const colors = colorString.toUpperCase().split('');
        const validColors = ['R', 'G', 'B', 'Y', 'O', 'W'];
        
        for (let i = 0; i < 9; i++) {
            const color = colors[i];
            if (!validColors.includes(color)) {
                return false;
            }
            
            const element = document.querySelector(`[data-face="${face}"][data-pos="${i}"]`);
            updateSquareColor(element, color);
            cubeState[face][i] = color;
        }
        

        
        return true;
    }
    
    // Update input fields with current cube state
    function updateInputFields() {
        Object.keys(cubeState).forEach(face => {
            const input = document.getElementById(`${face}-input`);
            if (input) {
                // Only update if the input is empty or if user has interacted with the grid
                if (input.value === '' || input.dataset.hasInteracted === 'true') {
                    input.value = cubeState[face].join('');
                }
            }
        });
    }
    

    
    // Create solution 3D cube
    function createSolution3DCube() {
        const container = document.getElementById('cube-3d-solution');
        container.innerHTML = '';
        
        // Create 3D cube structure for solution
        const cube = document.createElement('div');
        cube.className = 'cube-3d-wrapper-solution';
        
        // Create faces in proper order
        const faces = [
            { name: 'front', class: 'front-face' },
            { name: 'back', class: 'back-face' },
            { name: 'right', class: 'right-face' },
            { name: 'left', class: 'left-face' },
            { name: 'up', class: 'up-face' },
            { name: 'down', class: 'down-face' }
        ];
        
        faces.forEach(face => {
            const faceElement = document.createElement('div');
            faceElement.className = `cube-face-3d-solution ${face.class}`;
            
            // Create 3x3 grid for each face
            for (let i = 0; i < 9; i++) {
                const square = document.createElement('div');
                square.className = 'cube-square-3d-solution';
                square.dataset.face = face.name;
                square.dataset.pos = i;
                faceElement.appendChild(square);
            }
            
            cube.appendChild(faceElement);
        });
        
        container.appendChild(cube);
        
        // Update colors after creation
        updateSolution3DCube();
    }
    

    
    // Update solution 3D cube colors
    function updateSolution3DCube() {
        const faces = ['front', 'back', 'right', 'left', 'up', 'down'];
        faces.forEach(face => {
            for (let i = 0; i < 9; i++) {
                const square = document.querySelector(`.cube-square-3d-solution[data-face="${face}"][data-pos="${i}"]`);
                if (square) {
                    const color = cubeState[face][i];
                    updateSquareColor(square, color);
                }
            }
        });
    }
    
    // Color palette click handlers
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            // Remove active class from all options
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.style.border = '2px solid #333';
                opt.style.transform = 'scale(1)';
            });
            
            // Highlight selected color
            this.style.border = '3px solid #000';
            this.style.transform = 'scale(1.1)';
            
            selectedColor = this.getAttribute('data-color');
        });
    });
    
    // Cube square click handlers
    document.querySelectorAll('.cube-face[data-face]').forEach(square => {
        square.addEventListener('click', function() {
            const face = this.getAttribute('data-face');
            const pos = parseInt(this.getAttribute('data-pos'));
            
            updateSquareColor(this, selectedColor);
            cubeState[face][pos] = selectedColor;
            
            // Update the corresponding input field and mark as interacted
            const input = document.getElementById(`${face}-input`);
            if (input) {
                input.dataset.hasInteracted = 'true';
                input.value = cubeState[face].join('');
            }
            

        });
    });
    
    // Color string input handlers
    document.querySelectorAll('.color-string-input').forEach(input => {
        input.addEventListener('input', function() {
            const face = this.getAttribute('data-face');
            const colorString = this.value;
            
            if (colorString.length === 9) {
                if (parseColorString(face, colorString)) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            } else {
                this.classList.remove('is-valid', 'is-invalid');
            }
        });
        
        input.addEventListener('blur', function() {
            const face = this.getAttribute('data-face');
            const colorString = this.value;
            
            if (colorString.length > 0 && colorString.length !== 9) {
                this.classList.add('is-invalid');
            }
        });
    });
    
    function updateSquareColor(element, color) {
        // Remove all color classes
        Object.values(colorClasses).forEach(className => {
            element.classList.remove(className);
        });
        
        // Add new color class
        element.classList.add(colorClasses[color]);
    }
    
    // Reset button
    document.getElementById('reset-btn').addEventListener('click', function() {
        initializeCube();
        hideResults();
        
        // Clear input fields and reset interaction state
        document.querySelectorAll('.color-string-input').forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
            input.value = '';
            input.dataset.hasInteracted = 'false';
        });
    });
    
    // Solve button
    document.getElementById('solve-btn').addEventListener('click', function() {
        solveCube();
    });
    
    function solveCube() {
        // Show progress
        showProgress();
        hideResults();
        
        // Prepare data for API
        const cubeData = {
            front: cubeState.front,
            back: cubeState.back,
            right: cubeState.right,
            left: cubeState.left,
            up: cubeState.up,
            down: cubeState.down
        };
        
        // Send to backend
        fetch('/solve_manual', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(cubeData)
        })
        .then(response => response.json())
        .then(data => {
            hideProgress();
            
            if (data.success) {
                showSolution(data.solution, data.move_count);
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            hideProgress();
            showError('Network error: ' + error.message);
        });
    }
    
    function showProgress() {
        document.getElementById('progress-container').style.display = 'block';
    }
    
    function hideProgress() {
        document.getElementById('progress-container').style.display = 'none';
    }
    
    function showSolution(moves, moveCount) {
        document.getElementById('move-count').textContent = moveCount;
        
        // Convert moves to step-by-step instructions
        solutionSteps = convertMovesToSteps(moves);
        currentStep = 0;
        
        // Create solution 3D cube
        createSolution3DCube();
        
        // Display move sequence
        displayMoveSequence(moves);
        
        // Generate step grid
        generateStepGrid(moves);
        
        // Setup playback controls
        setupPlaybackControls();
        
        document.getElementById('solution-container').style.display = 'block';
    }
    
    function convertMovesToSteps(moves) {
        const steps = [];
        moves.forEach((move, index) => {
            const instruction = convertMoveToInstruction(move);
            steps.push({
                move: move,
                instruction: instruction,
                stepNumber: index + 1
            });
        });
        return steps;
    }
    
    function convertMoveToInstruction(move) {
        const faceMap = {
            'U': 'TOP',
            'D': 'BOTTOM', 
            'L': 'LEFT',
            'R': 'RIGHT',
            'F': 'FRONT',
            'B': 'BACK'
        };
        
        const face = faceMap[move[0]] || move[0];
        
        // Always use complete sentences with degrees
        if (move.endsWith("2")) {
            return `Turn the ${face} layer 180 degrees`;
        } else if (move.endsWith("'")) {
            return `Turn the ${face} layer 90 degrees counterclockwise`;
        } else {
            return `Turn the ${face} layer 90 degrees clockwise`;
        }
    }
    
    function displayMoveSequence(moves) {
        const container = document.getElementById('move-sequence-display');
        container.innerHTML = `<div class="move-sequence-text">${moves.join(' ')}</div>`;
    }
    
    function generateStepGrid(moves) {
        const container = document.getElementById('step-grid');
        container.innerHTML = '';
        
        // Create start state
        const startStep = createStepPanel('Start', '', 0, true);
        container.appendChild(startStep);
        
        // Create step panels for each move
        moves.forEach((move, index) => {
            const stepPanel = createStepPanel(`${index + 1}: ${move}`, move, index + 1, false);
            container.appendChild(stepPanel);
        });
    }
    
    function createStepPanel(title, move, stepNumber, isStart) {
        const panel = document.createElement('div');
        panel.className = 'step-panel';
        panel.dataset.step = stepNumber;
        
        const titleElement = document.createElement('div');
        titleElement.className = 'step-title';
        titleElement.textContent = title;
        panel.appendChild(titleElement);
        
        // Create mini cube representation
        const miniCube = document.createElement('div');
        miniCube.className = 'mini-cube';
        
        // Create 3 faces (top, front, right) like in the image
        const faces = ['up', 'front', 'right'];
        faces.forEach(face => {
            const faceElement = document.createElement('div');
            faceElement.className = `mini-face ${face}-mini`;
            
            // Create 3x3 grid for each face
            for (let i = 0; i < 9; i++) {
                const square = document.createElement('div');
                square.className = 'mini-square';
                square.dataset.face = face;
                square.dataset.pos = i;
                faceElement.appendChild(square);
            }
            
            miniCube.appendChild(faceElement);
        });
        
        panel.appendChild(miniCube);
        
        // Add move indicator if not start
        if (!isStart) {
            const indicator = createMoveIndicator(move);
            panel.appendChild(indicator);
        }
        
        return panel;
    }
    
    function createMoveIndicator(move) {
        const indicator = document.createElement('div');
        indicator.className = 'move-indicator';
        
        if (move.endsWith('2')) {
            indicator.innerHTML = '<span class="indicator-2x">2×</span>';
        } else {
            const arrow = move.endsWith("'") ? '↺' : '↻';
            indicator.innerHTML = `<span class="indicator-arrow">${arrow}</span>`;
        }
        
        return indicator;
    }
    
    function setupPlaybackControls() {
        const playPauseBtn = document.getElementById('play-pause');
        const progressSlider = document.getElementById('solution-progress');
        const rewindBtn = document.getElementById('rewind-start');
        const stepForwardBtn = document.getElementById('step-forward');
        const skipEndBtn = document.getElementById('skip-end');
        
        // Play/Pause functionality
        playPauseBtn.addEventListener('click', function() {
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        });
        
        // Progress slider
        progressSlider.addEventListener('input', function() {
            const step = Math.floor((this.value / 100) * solutionSteps.length);
            goToStep(step);
        });
        
        // Control buttons
        rewindBtn.addEventListener('click', () => goToStep(0));
        stepForwardBtn.addEventListener('click', () => goToStep(currentStep + 1));
        skipEndBtn.addEventListener('click', () => goToStep(solutionSteps.length - 1));
    }
    
    function startPlayback() {
        isPlaying = true;
        document.getElementById('play-pause').innerHTML = '<i class="fas fa-pause"></i>';
        
        playInterval = setInterval(() => {
            if (currentStep < solutionSteps.length - 1) {
                goToStep(currentStep + 1);
            } else {
                pausePlayback();
            }
        }, 3000); // 3 seconds per rotation
    }
    
    function pausePlayback() {
        isPlaying = false;
        document.getElementById('play-pause').innerHTML = '<i class="fas fa-play"></i>';
        
        if (playInterval) {
            clearInterval(playInterval);
            playInterval = null;
        }
    }
    
    function goToStep(step) {
        if (step < 0 || step >= solutionSteps.length) return;
        
        currentStep = step;
        
        // Update progress slider
        const progress = (step / solutionSteps.length) * 100;
        document.getElementById('solution-progress').value = progress;
        
        // Highlight current step in grid
        document.querySelectorAll('.step-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        
        const currentPanel = document.querySelector(`.step-panel[data-step="${step}"]`);
        if (currentPanel) {
            currentPanel.classList.add('active');
        }
        
        // Animate 3D cube if not start
        if (step > 0) {
            const move = solutionSteps[step - 1].move;
            animateSolution3DCubeMove(move);
        }
    }
    
    function animateSolution3DCubeMove(move) {
        const cube = document.querySelector('.cube-3d-wrapper-solution');
        if (!cube) return;
        
        // Parse move
        const face = move[0];
        const direction = move.slice(1);
        
        // Calculate rotation
        let rotation = 0;
        if (direction === "'") {
            rotation = -90;
        } else if (direction === "2") {
            rotation = 180;
        } else {
            rotation = 90;
        }
        
        // Add rotating class for smooth animation
        cube.classList.add('rotating');
        
        // Apply rotation animation based on face
        const faceMap = {
            'U': 'rotateX',
            'D': 'rotateX',
            'L': 'rotateY',
            'R': 'rotateY',
            'F': 'rotateZ',
            'B': 'rotateZ'
        };
        
        const axis = faceMap[face];
        if (axis) {
            // Get current transform
            const currentTransform = cube.style.transform;
            
            // Create new transform with additional rotation
            const newRotation = `${axis}(${rotation}deg)`;
            const newTransform = currentTransform + ' ' + newRotation;
            
            // Apply the new transform
            cube.style.transform = newTransform;
            
            // Reset after animation
            setTimeout(() => {
                cube.classList.remove('rotating');
            }, 1000);
        }
    }
    
    // Navigation buttons
    document.getElementById('prev-step').addEventListener('click', function() {
        if (currentStep > 0) {
            currentStep--;
            showCurrentStep();
        }
    });
    
    document.getElementById('next-step').addEventListener('click', function() {
        if (currentStep < solutionSteps.length - 1) {
            currentStep++;
            showCurrentStep();
        }
    });
    
    function showError(message) {
        document.getElementById('error-message').textContent = message;
        document.getElementById('error-container').style.display = 'block';
    }
    
    function hideResults() {
        document.getElementById('solution-container').style.display = 'none';
        document.getElementById('error-container').style.display = 'none';
    }
    
    // Initialize the cube on page load
    initializeCube();
    // Select white color by default
    document.querySelector('.color-option[data-color="W"]').click();
});
</script>
{% endblock %}
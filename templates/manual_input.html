{% extends "base.html" %}

{% block title %}Manual Input - Rubik's Cube Solver{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="text-center mb-4">
                <h2 class="text-white">
                    <i class="fas fa-keyboard"></i> Manual Cube Input
                </h2>
                <p class="text-white-50">Click on each square to select its color, or type color strings (e.g., "ggroowwbb") for each face!</p>
            </div>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-body">
                    <!-- Color Palette -->
                    <div class="row mb-4">
                        <div class="col-12 text-center">
                            <h5>Color Palette</h5>
                            <div class="color-palette d-flex justify-content-center flex-wrap gap-2 mt-3">
                                <div class="color-option cube-face color-red" data-color="R" title="Red"></div>
                                <div class="color-option cube-face color-green" data-color="G" title="Green"></div>
                                <div class="color-option cube-face color-blue" data-color="B" title="Blue"></div>
                                <div class="color-option cube-face color-yellow" data-color="Y" title="Yellow"></div>
                                <div class="color-option cube-face color-orange" data-color="O" title="Orange"></div>
                                <div class="color-option cube-face color-white" data-color="W" title="White"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cube Faces -->
                    <div class="cube-container">
                        <!-- Top Face (Up) -->
                        <div class="row justify-content-center mb-3">
                            <div class="col-auto">
                                <h6 class="text-center">Up Face</h6>
                                <div class="cube-grid" id="up-face">
                                    {% for i in range(9) %}
                                    <div class="cube-face" data-face="up" data-pos="{{ i }}"></div>
                                    {% endfor %}
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="up-input" placeholder="Enter 9 colors (e.g., WWWWWWWWW)" 
                                           maxlength="9" data-face="up" value="">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Middle Row -->
                        <div class="row justify-content-center mb-3">
                            <!-- Left Face -->
                            <div class="col-auto">
                                <h6 class="text-center">Left Face</h6>
                                <div class="cube-grid" id="left-face">
                                    {% for i in range(9) %}
                                    <div class="cube-face" data-face="left" data-pos="{{ i }}"></div>
                                    {% endfor %}
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="left-input" placeholder="Enter 9 colors (e.g., GGGGGGGGG)" 
                                           maxlength="9" data-face="left" value="">
                                </div>
                            </div>
                            
                            <!-- Front Face -->
                            <div class="col-auto">
                                <h6 class="text-center">Front Face</h6>
                                <div class="cube-grid" id="front-face">
                                    {% for i in range(9) %}
                                    <div class="cube-face" data-face="front" data-pos="{{ i }}"></div>
                                    {% endfor %}
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="front-input" placeholder="Enter 9 colors (e.g., RRRRRRRRR)" 
                                           maxlength="9" data-face="front" value="">
                                </div>
                            </div>
                            
                            <!-- Right Face -->
                            <div class="col-auto">
                                <h6 class="text-center">Right Face</h6>
                                <div class="cube-grid" id="right-face">
                                    {% for i in range(9) %}
                                    <div class="cube-face" data-face="right" data-pos="{{ i }}"></div>
                                    {% endfor %}
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="right-input" placeholder="Enter 9 colors (e.g., BBBBBBBBB)" 
                                           maxlength="9" data-face="right" value="">
                                </div>
                            </div>
                            
                            <!-- Back Face -->
                            <div class="col-auto">
                                <h6 class="text-center">Back Face</h6>
                                <div class="cube-grid" id="back-face">
                                    {% for i in range(9) %}
                                    <div class="cube-face" data-face="back" data-pos="{{ i }}"></div>
                                    {% endfor %}
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="back-input" placeholder="Enter 9 colors (e.g., OOOOOOOOO)" 
                                           maxlength="9" data-face="back" value="">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bottom Face -->
                        <div class="row justify-content-center mb-4">
                            <div class="col-auto">
                                <h6 class="text-center">Down Face</h6>
                                <div class="cube-grid" id="down-face">
                                    {% for i in range(9) %}
                                    <div class="cube-face" data-face="down" data-pos="{{ i }}"></div>
                                    {% endfor %}
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm color-string-input" 
                                           id="down-input" placeholder="Enter 9 colors (e.g., YYYYYYYYY)" 
                                           maxlength="9" data-face="down" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Controls -->
                    <div class="row">
                        <div class="col-12 text-center">
                            <button id="reset-btn" class="btn btn-warning me-2">
                                <i class="fas fa-undo"></i> Reset Cube
                            </button>
                            <button id="apply-input-btn" class="btn btn-info me-2">
                                <i class="fas fa-sync"></i> Apply Input
                            </button>
                            <button id="solve-button" class="btn btn-primary mb-3 solve-button">
                                <i class="fas fa-magic"></i> Solve Cube
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress Indicator -->
                    <div id="progress-container" class="mt-4" style="display: none;">
                        <div class="text-center">
                            <div class="loading-spinner"></div>
                            <p class="mt-2">Solving cube...</p>
                        </div>
                    </div>
                    
                    <!-- Solution Display -->
                    <div id="solution-container" class="solution-container" style="display: none; margin-top: 30px;">
                        <h4 class="text-center mb-3">
                            <i class="fas fa-check-circle text-success"></i> Solution Found!
                        </h4>
                        <div class="alert alert-success">
                            <strong>Move Count:</strong> <span id="move-count">0</span> moves
                        </div>
                        <!-- 3D Cube with Playback Controls -->
                        <div class="solution-3d-section mb-4">
                            <h5 class="text-center">Solution Visualization</h5>
                            <div class="cube-3d-container" style="height: 300px; margin-bottom: 20px;">
                                <div id="solution-cube-container" style="width: 100%; height: 100%;"></div>
                            </div>
                            <!-- Playback Controls -->
                            <div class="playback-controls text-center">
                                <div class="control-buttons mb-2">
                                    <button id="rewind-start" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-fast-backward"></i>
                                    </button>
                                    <button id="play-pause" class="btn btn-outline-primary btn-sm mx-1">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button id="step-forward" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-step-forward"></i>
                                    </button>
                                    <button id="skip-end" class="btn btn-outline-secondary btn-sm ms-1">
                                        <i class="fas fa-fast-forward"></i>
                                    </button>
                                </div>
                                <div class="progress-section">
                                    <input type="range" id="solution-progress" class="form-range" min="0" max="100" value="0">
                                    <span id="speed-indicator" class="badge bg-info">3 s/rot</span>
                                </div>
                            </div>
                        </div>
                        <!-- Move List -->
                        <div class="move-list-section mb-4">
                            <h5>Move Sequence:</h5>
                            <div class="move-sequence-display alert alert-light" id="move-sequence-display">
                                <!-- Move sequence will be displayed here -->
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                Move notation: U=Up, D=Down, L=Left, R=Right, F=Front, B=Back<br>
                                ' = Counterclockwise, 2 = Double turn
                            </small>
                        </div>
                    </div>
                    
                    <!-- Error Display -->
                    <div id="error-container" class="mt-4" style="display: none;">
                        <div class="alert alert-danger">
                            <strong>Error:</strong> <span id="error-message"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Load the 3D Cube modules -->
<script src="https://unpkg.com/three@0.154.0/build/three.module.js"></script>
<script type="module" src="{{ url_for('static', filename='js/cube3d.js') }}"></script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedColor = 'W'; // Default to white
    let cubeState = {
        up: Array(9).fill('W'),
        down: Array(9).fill('Y'),
        front: Array(9).fill('R'),
        back: Array(9).fill('O'),
        left: Array(9).fill('G'),
        right: Array(9).fill('B')
    };
    
    let solutionSteps = [];
    let currentStep = 0;
    let isPlaying = false;
    let playInterval = null;
    
    // Color class mapping
    const colorClasses = {
        'R': 'color-red',
        'G': 'color-green',
        'B': 'color-blue',
        'Y': 'color-yellow',
        'O': 'color-orange',
        'W': 'color-white'
    };
    
    // Color string to color mapping (case insensitive)
    const colorStringMap = {
        'r': 'R', 'R': 'R',
        'g': 'G', 'G': 'G',
        'b': 'B', 'B': 'B',
        'y': 'Y', 'Y': 'Y',
        'o': 'O', 'O': 'O',
        'w': 'W', 'W': 'W'
    };
    
    // Wait for cube3D module to be ready
    function waitForCube3D(callback) {
        if (window.cube3D) {
            callback();
        } else {
            setTimeout(() => waitForCube3D(callback), 100);
        }
    }
    
    // Initialize cube with default colors
    function initializeCube() {
        // Set default solved cube
        const defaultColors = {
            up: Array(9).fill('W'),
            down: Array(9).fill('Y'),
            front: Array(9).fill('R'),
            back: Array(9).fill('O'),
            left: Array(9).fill('G'),
            right: Array(9).fill('B')
        };
        
        Object.keys(defaultColors).forEach(face => {
            for (let i = 0; i < 9; i++) {
                const element = document.querySelector(`[data-face="${face}"][data-pos="${i}"]`);
                if (element) {
                    const color = defaultColors[face][i];
                    updateSquareColor(element, color);
                    cubeState[face][i] = color;
                }
            }
        });
        
        // Initialize the 3D preview
        waitForCube3D(() => {
            window.cube3D.initPreview();
            window.cube3D.updatePreview(cubeState);
        });
    }

    // Parse color string and update face
    function parseColorString(face, colorString) {
        if (colorString.length !== 9) {
            return false;
        }
        
        const colors = colorString.split('').map(c => {
            // Convert to uppercase and map to standard color code
            const upperC = c.toUpperCase();
            return colorStringMap[upperC] || upperC;
        });
        const validColors = ['R', 'G', 'B', 'Y', 'O', 'W'];
        
        for (let i = 0; i < 9; i++) {
            const color = colors[i];
            if (!validColors.includes(color)) {
                return false;
            }
            
            const element = document.querySelector(`[data-face="${face}"][data-pos="${i}"]`);
            updateSquareColor(element, color);
            cubeState[face][i] = color;
        }
        
        return true;
    }
    
    // Update input fields with current cube state
    function updateInputFields() {
        Object.keys(cubeState).forEach(face => {
            const input = document.getElementById(`${face}-input`);
            if (input) {
                // Only update if the input is empty or if user has interacted with the grid
                if (input.value === '' || input.dataset.hasInteracted === 'true') {
                    input.value = cubeState[face].join('');
                }
            }
        });
    }
    
    // Color palette click handlers
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            // Remove active class from all options
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.style.border = '2px solid #333';
                opt.style.transform = 'scale(1)';
            });
            
            // Highlight selected color
            this.style.border = '3px solid #000';
            this.style.transform = 'scale(1.1)';
            
            selectedColor = this.getAttribute('data-color');
        });
    });
    
    // Cube square click handlers
    document.querySelectorAll('.cube-face[data-face]').forEach(square => {
        square.addEventListener('click', function() {
            const face = this.getAttribute('data-face');
            const pos = parseInt(this.getAttribute('data-pos'));
            
            updateSquareColor(this, selectedColor);
            cubeState[face][pos] = selectedColor;
            
            // Update the corresponding input field and mark as interacted
            const input = document.getElementById(`${face}-input`);
            if (input) {
                input.dataset.hasInteracted = 'true';
                input.value = cubeState[face].join('');
            }
            
            // Update 3D preview
            waitForCube3D(() => {
                window.cube3D.updatePreview(cubeState);
            });
        });
    });
    
    // Color string input handlers
    document.querySelectorAll('.color-string-input').forEach(input => {
        input.addEventListener('input', function() {
            const face = this.getAttribute('data-face');
            const colorString = this.value;
            
            if (colorString.length === 9) {
                if (parseColorString(face, colorString)) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    
                    // Update 3D preview
                    waitForCube3D(() => {
                        window.cube3D.updatePreview(cubeState);
                    });
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            } else {
                this.classList.remove('is-valid', 'is-invalid');
            }
        });
        
        input.addEventListener('blur', function() {
            const face = this.getAttribute('data-face');
            const colorString = this.value;
            
            if (colorString.length > 0 && colorString.length !== 9) {
                this.classList.add('is-invalid');
            }
        });
    });
    
    function updateSquareColor(element, color) {
        // Remove all color classes
        Object.values(colorClasses).forEach(className => {
            element.classList.remove(className);
        });
        
        // Add new color class
        element.classList.add(colorClasses[color]);
    }
    
    // Reset button
    document.getElementById('reset-btn').addEventListener('click', function() {
        initializeCube();
        hideResults();
        
        // Clear input fields and reset interaction state
        document.querySelectorAll('.color-string-input').forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
            input.value = '';
            input.dataset.hasInteracted = 'false';
        });
    });

    // Apply Input button
    document.getElementById('apply-input-btn').addEventListener('click', function() {
        let isValid = true;
        const faces = ['up', 'down', 'front', 'back', 'left', 'right'];
        const validColors = ['R', 'G', 'B', 'Y', 'O', 'W'];
        const colorCounts = {
            'R': 0, 'G': 0, 'B': 0, 'Y': 0, 'O': 0, 'W': 0
        };

        // First validate all inputs
        faces.forEach(face => {
            const input = document.getElementById(`${face}-input`);
            if (!input || !input.value) {
                showError(`Missing input for ${face} face`);
                isValid = false;
                return;
            }

            const colorString = input.value;
            if (colorString.length !== 9) {
                showError(`Invalid input length for ${face} face`);
                isValid = false;
                return;
            }

            // Check if all characters are valid colors and convert them
            const colors = colorString.split('').map(c => {
                const upperC = c.toUpperCase();
                return colorStringMap[upperC] || upperC;
            });
            
            for (const color of colors) {
                if (!validColors.includes(color)) {
                    showError(`Invalid color "${color}" in ${face} face`);
                    isValid = false;
                    return;
                }
                colorCounts[color]++;
            }
        });

        // Check if we have exactly 9 of each color
        for (const [color, count] of Object.entries(colorCounts)) {
            if (count !== 9) {
                showError(`Invalid configuration: Found ${count} ${color}'s (should be 9)`);
                isValid = false;
                return;
            }
        }

        // If all validations pass, apply the colors
        if (isValid) {
            faces.forEach(face => {
                const input = document.getElementById(`${face}-input`);
                const colorString = input.value.toUpperCase();
                if (parseColorString(face, colorString)) {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                }
            });

            // Show success message
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
            successAlert.innerHTML = `
                <strong>Success!</strong> Colors applied to cube faces.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.cube-container').insertAdjacentElement('beforebegin', successAlert);

            // Auto-dismiss the alert after 3 seconds
            setTimeout(() => {
                successAlert.remove();
            }, 3000);
        }
    });
    
    // Solve button
    document.getElementById('solve-button').addEventListener('click', function() {
        solveCube();
    });
    
    function solveCube() {
        // Show progress
        showProgress();
        hideResults();
        
        // Prepare data for API
        const cubeData = {
            front: cubeState.front,
            back: cubeState.back,
            right: cubeState.right,
            left: cubeState.left,
            up: cubeState.up,
            down: cubeState.down
        };
        
        // Send to backend
        fetch('/solve_manual', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(cubeData)
        })
        .then(response => response.json())
        .then(data => {
            hideProgress();
            
            if (data.success) {
                showSolution(data.solution, data.move_count);
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            hideProgress();
            showError('Network error: ' + error.message);
        });
    }
    
    function showProgress() {
        document.getElementById('progress-container').style.display = 'block';
    }
    
    function hideProgress() {
        document.getElementById('progress-container').style.display = 'none';
    }
    
    function showSolution(moves, moveCount) {
        document.getElementById('move-count').textContent = moveCount;
        
        // Convert moves to step-by-step instructions
        solutionSteps = convertMovesToSteps(moves);
        currentStep = 0;
        
        // Initialize solution cube
        waitForCube3D(() => {
            window.cube3D.initSolution();
            window.cube3D.updateSolution(cubeState);
        });
        
        // Display move sequence
        displayMoveSequence(moves);
        
        // Setup playback controls
        setupPlaybackControls();
        
        document.getElementById('solution-container').style.display = 'block';
    }
    
    function convertMovesToSteps(moves) {
        const steps = [];
        moves.forEach((move, index) => {
            const instruction = convertMoveToInstruction(move);
            steps.push({
                move: move,
                instruction: instruction,
                stepNumber: index + 1
            });
        });
        return steps;
    }
    
    function convertMoveToInstruction(move) {
        const faceMap = {
            'U': 'TOP',
            'D': 'BOTTOM', 
            'L': 'LEFT',
            'R': 'RIGHT',
            'F': 'FRONT',
            'B': 'BACK'
        };
        
        const face = faceMap[move[0]] || move[0];
        
        // Always use complete sentences with degrees
        if (move.endsWith("2")) {
            return `Turn the ${face} layer 180 degrees`;
        } else if (move.endsWith("'")) {
            return `Turn the ${face} layer 90 degrees counterclockwise`;
        } else {
            return `Turn the ${face} layer 90 degrees clockwise`;
        }
    }
    
    function displayMoveSequence(moves) {
        const container = document.getElementById('move-sequence-display');
        container.innerHTML = `<div class="move-sequence-text">${moves.join(' ')}</div>`;
    }
    
    function setupPlaybackControls() {
        const playPauseBtn = document.getElementById('play-pause');
        const progressSlider = document.getElementById('solution-progress');
        const rewindBtn = document.getElementById('rewind-start');
        const stepForwardBtn = document.getElementById('step-forward');
        const skipEndBtn = document.getElementById('skip-end');
        
        // Play/Pause functionality
        playPauseBtn.addEventListener('click', function() {
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        });
        
        // Progress slider
        progressSlider.addEventListener('input', function() {
            const step = Math.floor((this.value / 100) * solutionSteps.length);
            goToStep(step);
        });
        
        // Control buttons
        rewindBtn.addEventListener('click', () => goToStep(0));
        stepForwardBtn.addEventListener('click', () => goToStep(currentStep + 1));
        skipEndBtn.addEventListener('click', () => goToStep(solutionSteps.length - 1));
    }
    
    function startPlayback() {
        isPlaying = true;
        document.getElementById('play-pause').innerHTML = '<i class="fas fa-pause"></i>';
        
        playInterval = setInterval(() => {
            if (currentStep < solutionSteps.length - 1) {
                goToStep(currentStep + 1);
            } else {
                pausePlayback();
            }
        }, 3000); // 3 seconds per rotation
    }
    
    function pausePlayback() {
        isPlaying = false;
        document.getElementById('play-pause').innerHTML = '<i class="fas fa-play"></i>';
        
        if (playInterval) {
            clearInterval(playInterval);
            playInterval = null;
        }
    }
    
    function goToStep(step) {
        if (step < 0 || step >= solutionSteps.length) return;
        
        currentStep = step;
        
        // Update progress slider
        const progress = (step / solutionSteps.length) * 100;
        document.getElementById('solution-progress').value = progress;
        
        // Animate 3D cube if not start
        if (step > 0) {
            const move = solutionSteps[step - 1].move;
            waitForCube3D(() => {
                window.cube3D.animateSolutionMove(move);
            });
        }
    }
    
    function showError(message) {
        document.getElementById('error-message').textContent = message;
        document.getElementById('error-container').style.display = 'block';
    }
    
    function hideResults() {
        document.getElementById('solution-container').style.display = 'none';
        document.getElementById('error-container').style.display = 'none';
    }
    
    // Initialize the cube on page load
    initializeCube();
    // Select white color by default
    document.querySelector('.color-option[data-color="W"]').click();
});
</script>
{% endblock %}